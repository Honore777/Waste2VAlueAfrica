{% extends "base.html" %}
{% block title %}{{ post.title }} | Waste2Value Africa{% endblock %}

{% block content %}
<div class="bg-white p-8 rounded-2xl shadow-lg max-w-3xl mx-auto">
    
    <h1 class="text-3xl font-bold text-gray-800 mb-4">{{ post.title }}</h1>

    <p class="text-gray-700 mb-4" style="white-space: pre-line;">
        {{ post.content }}
    </p>

    {% if post.image %}
    <div class="mb-4">
        <img src="{{ url_for('static', filename='uploads/posts/' + post.image) }}" 
             alt="Post Image"
             class="rounded-lg shadow-md max-w-full h-auto">
    </div>
    {% endif %}

    <p class="text-sm text-gray-500">
        Posted by {{ post.author.username if post.author else 'Unknown' }}
        on {{ post.created_at.strftime('%Y-%m-%d') }}
    </p>

    <!-- Upvote Button -->
    <div class="flex items-center gap-6 mt-6 text-gray-700">

        <!--upvote-->
    <button class="upvote-btn px-3 py-1 bg-green-100 text-green-700 rounded-lg hover:bg-green-200"
            data-post-id="{{ post.id }}">
        üëç Upvote (<span class="upvote-count">{{ post.upvotes.count() }}</span>)
    </button>

    <!-- comments-->
     <button id="toggle-comments"
     class="flex items-center gap-1 px-3 py-1 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200"
     >
      üí¨ <span id="comment-count">{{ post.comments.count() }}</span>

     </button>

     <!-- Share -->
    <button id="share-button"
            class="flex items-center gap-1 px-3 py-1 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200">
        ‚Üó Share
    </button>



</div>

<!-- Comment Section -->
<div id="comment-section" class="mt-6 hidden">

    <!-- Add a Comment -->
    <form id="comment-form" class="mb-4">
        <textarea id="comment-input"
                  class="w-full p-3 border rounded-lg focus:ring focus:outline-none"
                  rows="3" placeholder="Write a comment..."></textarea>
        <button type="submit"
                class="mt-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
            Post Comment
        </button>
    </form>

    <!-- Display Existing Comments -->
    <div id="comments-list">
        {% for comment in post.comments %}
            <div class="comment p-3 border rounded-lg mb-3 bg-gray-50" data-comment-id="{{ comment.id }}">
                <p class="font-semibold">{{ comment.author.username if comment.author else "Unknown" }}</p>
                <p class="text-gray-700">{{ comment.content }}</p>
                <button class="reply-btn text-sm text-blue-600" data-comment-id="{{ comment.id }}">Reply</button>

                <!-- Replies -->
                <div class="ml-6 mt-2">
                    {% for reply in comment.replies %}
                        <div class="p-2 border rounded-lg mb-2 bg-white" data-comment-id="{{ reply.id }}">
                            <p class="font-semibold">{{ reply.author.username if reply.author else "Unknown" }}</p>
                            <p class="text-gray-700">{{ reply.content }}</p>
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endfor %}
    </div>

</div>




 </div>










</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

    document.querySelectorAll('.upvote-btn').forEach(button => {
        button.addEventListener('click', async () => {
            const postId = button.dataset.postId;
            console.log("Click post ID:", postId); // Debug

            const response = await fetch(`/community/upvote/${postId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': csrfToken
                },
                credentials: 'include'
            });

            try {
                const data = await response.json();
                console.log("Upvote response:", data); // Debug
                if (data.status === 'success') {
                    button.querySelector('.upvote-count').textContent = data.total_upvotes;
                }
            } catch (err) {
                console.error("Failed to parse JSON:", err, await response.text());
            }
        });
    });
});

document.addEventListener('DOMContentLoaded', ()=>{

    const csrfToken= document.querySelector('meta[name="csrf-token"]').getAttribute('content');

    const commentForm= document.getElementById('comment-form')
    const commentInput= document.getElementById('comment-input');
    const commentsList= document.getElementById('comments-list');

    commentForm.addEventListener('submit', async(e)=>{
        e.preventDefault();

        const content= commentInput.value.trim();
        if(!content) return;

        const response= await fetch(`{{url_for('community.post_comment', slug=post.slug)}}`,{
            method:'POST',
            headers:{
                'Content-Type':'application/x-www-form-urlencoded',
                'X-CSRFToken': csrfToken
            },
            body: new URLSearchParams({content:content}),
            credentials:'include'
            
        });

        const data= await response.json();

        if (data.status === 'success'){

            const newComment= document.createElement('div');
            newComment.classList.add('comment', 'p-3','border', 'rounded-lg', 'mb-3', 'bg-gray-50');
            newComment.dataset.commentId= data.comment.id;
             newComment.innerHTML = `
                <p class="font-semibold">${data.comment.author}</p>
                <p class="text-gray-700">${data.comment.content}</p>
                <button class="reply-btn text-sm text-blue-600" data-comment-id="${data.comment.id}">Reply</button>
                <div class="ml-6 mt-2"></div>
            `;
            commentsList.prepend(newComment);  // insert on top

            // Clear textarea
            commentInput.value = '';
            
            // Update comment count
            document.getElementById('comment-count').textContent = data.total_comments;
        }
    });



        }

    )
    
    const toggleCommentsBtn = document.getElementById('toggle-comments');
const commentSection = document.getElementById('comment-section');

toggleCommentsBtn.addEventListener('click', () => {
    commentSection.classList.toggle('hidden');
});



document.addEventListener('DOMContentLoaded', ()=>{

    const csrfToken= document.querySelector('meta[name="csrf-token"]').getAttribute('content')
    
    document.querySelectorAll('.reply-btn').forEach(btn=>{
        btn.addEventListener('click', function (){

            const commentId= this.dataset.commentId;
            const commentBox= this.closest('.comment')

            if(commentBox.querySelector('.reply-form')){
                return;
            }


            const form= document.createElement('form');
            form.classList.add('reply-form', 'mt-2');

            form.innerHTML=`

             <textarea class="w-full p-2 border rounded-lg reply-input"
                          rows="2" placeholder="Write a reply..."></textarea>
                <button type="submit"
                    class="mt-1 px-3 py-1 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    Reply
                </button>
            
            `
            commentBox.appendChild(form);

            form.addEventListener('submit', async (e)=>{

                e.preventDefault();
                const content= form.querySelector('.reply-input').value.trim();

                if (!content) return;

                const response= await fetch (`/community/comment/{{post.slug}}`,{
                    method:'POST',
                    headers: {
                        'Content-Type':'application/x-www-form-urlencoded',
                        'X-CSRFToken':csrfToken
                    },
                    
                    body: new URLSearchParams({content:content, parent_id:commentId})
                });

                const data= await response.json();

                if(data.status === 'success'){

                    const repliesDiv= commentBox.querySelector('.ml-6');

                    const newReply= document.createElement('div');

                    newReply.classList.add('p-2', 'border', 'rounded-lg', 'mb-2', 'bg-white');
                    newReply.innerHTML=`

                     <p class="font-semibold">${data.comment.author}</p>
                        <p class="text-gray-700">${data.comment.content}</p>
                    `;

                    repliesDiv.appendChild(newReply);
                    form.remove();

                }




            })


        })
    })


})





</script>

{% endblock %}